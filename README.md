# 카카오톡 강화 매크로

카카오톡 채팅방 봇에 `/강화` 명령어를 자동 반복 전송하는 macOS 전용 매크로.
목표 레벨 도달 시 자동 종료. OCR로 채팅 결과를 읽어 성공/파괴를 판별한다.

## 설치

```bash
pip install -r requirements.txt
```

## 실행

```bash
python3 enhance_macro.py
```

실행 후 흐름:
1. 카카오톡에서 채팅방 열기
2. 터미널에 채팅방 이름 입력
3. 메뉴에서 `5. goal`로 목표 레벨 확인/변경
4. `1. start` 입력
5. **현재 레벨 입력** (예: 지금 +7이면 `7` 입력)
6. 매크로 자동 진행 → 목표 레벨 도달 시 자동 종료
7. 수동 종료: `Ctrl+C`

> **현재 레벨 입력이 필요한 이유**: 입력하지 않으면 항상 0에서 시작하는 것으로 간주되어
> 이미 목표 레벨 이상인 경우에도 강화를 계속 전송합니다.

## 메뉴

| 입력 | 기능 |
|------|------|
| `1` / `start` | 매크로 시작 |
| `2` / `stats` | 통계 보기 |
| `3` / `reset` | 통계 초기화 |
| `4` / `room` | 채팅방 변경 |
| `5` / `goal` | 목표 레벨 변경 |
| `6` / `gold` | 골드 리밋 변경 |
| `7` / `quit` | 종료 |

## 주요 설정값

`enhance_macro.py` 상단에서 변경:

```python
TARGET_LEVEL = 13          # 이 레벨 도달 시 자동 종료
GOLD_LIMIT   = 0           # 이 골드 미만이 되면 종료 (0 = 기능 비활성화)
SUCCESS_TEXT = "강화에 성공"  # 봇 성공 메시지 키워드
FAIL_TEXT    = "강화 파괴"   # 봇 파괴 메시지 키워드
COMMAND      = "/강화"       # 채팅방에 전송할 명령어
```

## macOS 권한 설정

이 매크로는 두 가지 macOS 권한이 관련되며, **화면 기록 권한만 필요**합니다.

| 권한 | 필요 여부 | 용도 |
|------|-----------|------|
| 손쉬운 사용 (Accessibility) | **불필요** | AX API value 방식으로 카카오톡 입력창에 직접 값을 쓰므로 권한 불필요 |
| 화면 기록 (Screen Recording) | **필요** | `pyautogui.screenshot()`으로 채팅창을 캡처해 OCR 분석 |

### 화면 기록 권한 추가 방법

**macOS Ventura 이상 (13.0+)**

1. 애플 메뉴() → **시스템 설정** 클릭
2. 왼쪽 사이드바에서 **개인정보 보호 및 보안** 클릭
3. 오른쪽에서 스크롤 → **화면 기록 및 시스템 오디오** 클릭
4. 목록에서 **터미널** (또는 사용 중인 터미널 앱) 찾아 토글 **켜기**
   - 목록에 없으면 좌하단 `+` 버튼 → `/Applications/Utilities/Terminal.app` 선택
5. 터미널을 **완전히 종료 후 재시작** (권한이 즉시 적용되지 않을 수 있음)

**macOS Monterey 이하 (12.0 이하)**

1. 애플 메뉴() → **시스템 환경설정** 클릭
2. **보안 및 개인 정보 보호** 클릭
3. 상단 **개인 정보 보호** 탭 클릭
4. 왼쪽 목록에서 **화면 기록** 클릭
5. 좌하단 자물쇠 아이콘 클릭 → 비밀번호 입력 (잠금 해제)
6. **터미널** 체크박스 체크
7. 터미널 **재시작**

### 터미널 앱별 참고

| 터미널 앱 | 권한 부여 대상 |
|-----------|----------------|
| 기본 터미널 | Terminal.app |
| iTerm2 | iTerm.app |
| VS Code 터미널 | Visual Studio Code.app |
| PyCharm 터미널 | PyCharm.app |

> 스크립트를 실행하는 앱에 권한을 부여해야 합니다.
> VS Code나 PyCharm 내장 터미널에서 실행한다면 해당 앱에 화면 기록 권한을 줘야 합니다.

### 권한이 없을 때 나타나는 증상

- `pyautogui.screenshot()` 호출 시 **검은 화면** 또는 **빈 이미지** 캡처
- OCR 결과가 항상 빈 배열 `[]` 반환
- `[시간초과] 응답 없음` 로그가 매번 출력됨

## 파일 구조

```
kakao_macro/
├── enhance_macro.py       # 메인 스크립트
├── enhance_stats.json     # 통계 데이터 (자동 생성)
├── requirements.txt       # 의존성
├── README.md
└── CLAUDE.md              # 개발 문서
```

## 통계

매크로 실행 중 자동으로 `enhance_stats.json`에 기록된다.

- 레벨별 성공/파괴 횟수
- 전체 시도 횟수 및 최고 도달 레벨
- `+20` 도달 확률 몬테카를로 시뮬레이션 (10,000회)

## 트러블슈팅

**OCR이 항상 `[시간초과] 응답 없음`을 출력할 때**
- 화면 기록 권한 확인 (위 섹션 참조)
- 권한 추가 후 터미널 재시작 필수

**메시지가 전송되지 않을 때**
- 카카오톡 채팅방 창이 화면에 열려 있는지 확인
- 채팅방 이름이 정확한지 확인 (부분 일치도 동작)

**자동완성 팝업 타이밍 오류로 명령어가 일반 텍스트로 전송될 때**
- `send_command()` 내 `delay 0.6` 값을 `0.8 ~ 1.0`으로 늘린다

**목표 레벨 도달해도 안 멈출 때**
- `[DEBUG]` 로그에서 `result`, `from`, `to` 값 확인
- `SUCCESS_TEXT` 키워드가 실제 봇 메시지와 일치하는지 확인
- 채팅창 크기를 키우면 OCR 정확도 향상
